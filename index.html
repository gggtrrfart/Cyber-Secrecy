<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cyber Secrecy Expanded</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
<style>
  /* Reset & base */
  html, body {
    height: 100%;
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #001000, #003300);
    font-family: 'JetBrains Mono', monospace;
    color: #00ff00;
    overflow: hidden;
  }

  /* Tabs bar */
  #tabs {
    display: flex;
    background: #002200cc;
    border-bottom: 1px solid #00ff00;
    user-select: none;
  }
  #tabs button {
    flex: 1;
    padding: 12px 0;
    background: transparent;
    border: none;
    color: #00ff00;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1rem;
    text-shadow: 0 0 4px #00ff00;
    transition: background 0.3s;
  }
  #tabs button.active, #tabs button:hover {
    background: #004400dd;
  }

  /* Content panes */
  .tab-content {
    position: absolute;
    top: 44px; /* tabs height + border */
    bottom: 0;
    left: 0;
    right: 0;
    background: #050505;
    box-shadow: 0 0 20px #00ff00aa;
    display: none;
  }
  .tab-content.active {
    display: block;
  }

  /* Terminal container */
  #terminal-container .xterm {
    font-size: 14px;
  }

  /* Server list styling */
  #servers-list {
    padding: 12px;
    overflow-y: auto;
    height: 100%;
    font-family: monospace;
    white-space: pre-wrap;
  }

  /* Cameras */
  #cams-feed {
    padding: 12px;
    color: #00ff00;
    font-family: monospace;
    overflow-y: auto;
    height: 100%;
  }

  /* Phone */
  #phone-messages {
    padding: 12px;
    height: calc(100% - 50px);
    overflow-y: auto;
    font-family: monospace;
  }
  #phone-input {
    width: 100%;
    box-sizing: border-box;
    background: #001a00;
    border: 1px solid #00ff00;
    color: #00ff00;
    font-family: monospace;
    padding: 8px;
  }

  /* Malware editor */
  #malware-editor {
    height: 100%;
  }
  #malware-textarea {
    width: 100%;
    height: 100%;
    background: #001a00;
    color: #00ff00;
    font-family: monospace;
    font-size: 14px;
    border: none;
    padding: 12px;
    box-sizing: border-box;
    resize: none;
  }
  #run-malware-btn {
    position: absolute;
    bottom: 12px;
    right: 12px;
    background: #004400cc;
    border: 1px solid #00ff00;
    color: #00ff00;
    padding: 8px 16px;
    font-family: monospace;
    cursor: pointer;
  }

</style>
</head>
<body>

<!-- Tabs -->
<div id="tabs">
  <button data-tab="terminal" class="active">Terminal</button>
  <button data-tab="servers">Servers</button>
  <button data-tab="cams">Cameras</button>
  <button data-tab="phone">Phone</button>
  <button data-tab="malware">Malware Editor</button>
</div>

<!-- Terminal Tab -->
<div id="terminal-container" class="tab-content active"></div>

<!-- Servers Tab -->
<div id="servers-list" class="tab-content"></div>

<!-- Cameras Tab -->
<div id="cams-feed" class="tab-content"></div>

<!-- Phone Tab -->
<div class="tab-content" id="phone-tab" style="display:flex; flex-direction: column;">
  <div id="phone-messages"></div>
  <input id="phone-input" placeholder="Type message and press Enter" />
</div>

<!-- Malware Editor Tab -->
<div id="malware-editor" class="tab-content" style="position: relative;">
  <textarea id="malware-textarea" spellcheck="false">// Write malware script here
print("Hello, Malware World!");
scan();
</textarea>
  <button id="run-malware-btn">Run Malware</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-interpreter@latest/interpreter.js"></script>

<script>
  // === Globals ===
  const { Terminal } = window;
  const term = new Terminal({
    cursorBlink: true,
    scrollback: 5000,
    fontSize: 14,
    fontFamily: '"JetBrains Mono", monospace',
    theme: {
      background: '#0a0a0a',
      foreground: '#00ff00',
      cursor: '#00ff00',
      selectionBackground: 'rgba(0,255,0,0.3)'
    }
  });
  term.open(document.getElementById('terminal-container'));

  const PROMPT = '>| ';
  let commandBuffer = '';
  let mode = "command"; // or "edit"
  let currentEditLines = [];
  let currentEditFile = "";

  // Files system (in memory)
  const files = {
    'readme.txt': 'Welcome.\nUse ls, cat, edit, run commands.\nTry hacking AI servers!',
  };

  // Hacker Ranks & Trust system (simplified)
  const hackerRanks = {
    "alpha_hacker": 5,
    "beta_hacker": 3,
    "gamma_hacker": 1
  };
  // Player trust (initially empty)
  const playerTrust = {};

  // FBI Alert system (basic)
  let fbiAlertLevel = 0; // 0 = safe, up to 100 = caught

  // AI Servers (randomized)
  const serverPrefixes = ['alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'omega', 'sigma', 'theta'];
  const serverTLDs = ['net', 'io', 'sys', 'org', 'com', 'tech'];

  const fakeServers = {};

  function randomInt(min, max) {
    return Math.floor(Math.random()*(max-min+1))+min;
  }

  function randomChoice(arr) {
    return arr[randomInt(0, arr.length-1)];
  }

  function createRandomServer(id) {
    const name = `${randomChoice(serverPrefixes)}${id}.${randomChoice(serverTLDs)}`;
    return {
      id,
      name,
      vulnerable: Math.random() < 0.6,
      cameraOn: Math.random() < 0.5,
      hacked: false,
      alertLevel: 0,      // 0..100 alert level
      malwareInstalled: false,
      aiHackerName: randomChoice(Object.keys(hackerRanks)),
      suspicion: 0,       // 0..100 suspicion of player watching
      trustLevel: 0,      // 0..5 trust with player
      messages: [],
      lastSeenTyping: 0,
    };
  }

  // Initialize 8 random servers
  for(let i=1; i<=8; i++) {
    fakeServers[i] = createRandomServer(i);
  }

  // === Terminal helpers ===
  function scrollBottom() {
    setTimeout(() => term.scrollToBottom(), 0);
  }

  function prompt() {
    term.write('\r\n' + PROMPT);
    scrollBottom();
  }

  function print(text = '') {
    term.writeln(text);
    scrollBottom();
  }

  function listFiles() {
    const names = Object.keys(files);
    print(names.length ? names.join('  ') : '(no files)');
  }

  function catFile(filename) {
    print(filename in files ? files[filename] : `cat: no such file: ${filename}`);
  }

  function editFile(filename) {
    print(`Editing ${filename}. End with '.' on a line.`);
    mode = "edit";
    currentEditLines = [];
    currentEditFile = filename;
    term.write('\r\n> ');
  }

  // Scripting interpreter for malware & scripts
  function runScript(scriptText, onFinish) {
    const interpreter = new Interpreter(scriptText, function(interpreter, globalObject) {
      // print(text)
      interpreter.setProperty(globalObject, 'print',
        interpreter.createNativeFunction(function(text) {
          print(String(text));
        })
      );

      // scan()
      interpreter.setProperty(globalObject, 'scan',
        interpreter.createNativeFunction(function() {
          return Object.values(fakeServers).map(s => s.name).join('\n');
        })
      );

      // probe(serverName)
      interpreter.setProperty(globalObject, 'probe',
        interpreter.createNativeFunction(function(serverName) {
          const s = Object.values(fakeServers).find(srv => srv.name === String(serverName));
          if (!s) return 'UNKNOWN HOST';
          return s.vulnerable ? 'VULNERABLE' : 'SECURE';
        })
      );

      // cameraStatus(serverName)
      interpreter.setProperty(globalObject, 'cameraStatus',
        interpreter.createNativeFunction(function(serverName) {
          const s = Object.values(fakeServers).find(srv => srv.name === String(serverName));
          if (!s) return 'UNKNOWN HOST';
          return s.cameraOn ? 'ONLINE' : 'OFFLINE';
        })
      );

      // hack(serverName)
      interpreter.setProperty(globalObject, 'hack',
        interpreter.createNativeFunction(function(serverName) {
          const s = Object.values(fakeServers).find(srv => srv.name === String(serverName));
          if (!s) return 'FAIL: NO HOST';
          if (s.hacked) return 'ALREADY HACKED';
          if (!s.vulnerable) return 'FAIL: SECURE';
          if (s.cameraOn) return 'FAIL: CAMERAS ONLINE';
          s.hacked = true;
          print(`SUCCESS: ${s.name} BREACHED`);
          return 'SUCCESS';
        })
      );

      // installMalware(serverName)
      interpreter.setProperty(globalObject, 'installMalware',
        interpreter.createNativeFunction(function(serverName) {
          const s = Object.values(fakeServers).find(srv => srv.name === String(serverName));
          if (!s) return 'FAIL: NO HOST';
          if (!s.hacked) return 'FAIL: NOT HACKED';
          s.malwareInstalled = true;
          print(`Malware installed on ${s.name}`);
          return 'SUCCESS';
        })
      );

      // getAlertLevel(serverName)
      interpreter.setProperty(globalObject, 'getAlertLevel',
        interpreter.createNativeFunction(function(serverName) {
          const s = Object.values(fakeServers).find(srv => srv.name === String(serverName));
          if (!s) return -1;
          return s.alertLevel;
        })
      );

      // increaseAlert(serverName, amount)
      interpreter.setProperty(globalObject, 'increaseAlert',
        interpreter.createNativeFunction(function(serverName, amount) {
          const s = Object.values(fakeServers).find(srv => srv.name === String(serverName));
          if (!s) return false;
          s.alertLevel = Math.min(100, s.alertLevel + amount);
          return true;
        })
      );

    });

    function runStep() {
      try {
        if (interpreter.step()) {
          setTimeout(runStep, 0);
        } else {
          print('Script finished.');
          if(onFinish) onFinish();
          prompt();
        }
      } catch (err) {
        print('Script Error: ' + err.message);
        if(onFinish) onFinish();
        prompt();
      }
    }

    runStep();
  }

  // Terminal commands
  function runFile(filename) {
    if (!(filename in files)) {
      print(`run: no such file: ${filename}`);
      prompt();
      return;
    }
    print(`Running ${filename}...`);
    runScript(files[filename]);
  }

  function handleCommand(line) {
    const parts = line.trim().split(' ');
    const cmd = parts[0];
    const arg = parts.slice(1).join(' ');

    switch (cmd) {
      case 'ls': listFiles(); prompt(); break;
      case 'cat': catFile(arg); prompt(); break;
      case 'edit': if (!arg) print('Usage: edit <filename>'); else editFile(arg); break;
      case 'run': if (!arg) print('Usage: run <filename>'); else runFile(arg); break;
      case 'help':
        print(`Commands: ls, cat, edit, run\nIn scripts try: print(), scan(), probe(), cameraStatus(), hack(), installMalware(), getAlertLevel()`);
        prompt();
        break;
      case '':
        prompt();
        break;
      default:
        print(`Unknown command: ${cmd}`);
        prompt();
    }
  }

  // Terminal input handling
  term.onKey(e => {
    const ev = e.domEvent;
    const printable = !ev.altKey && !ev.ctrlKey && !ev.metaKey;

    if (ev.key === 'Enter') {
      term.write('\r\n');
      if (mode === "command") {
        handleCommand(commandBuffer.trim());
        commandBuffer = '';
      } else if (mode === "edit") {
        const line = commandBuffer.trimEnd();
        commandBuffer = '';
        if (line === '.') {
          files[currentEditFile] = currentEditLines.join('\n');
          print(`Saved ${currentEditFile}`);
          mode = "command";
          currentEditFile = "";
          currentEditLines = [];
          prompt();
        } else {
          currentEditLines.push(line);
          term.write('> ');
        }
      }
    } else if (ev.key === 'Backspace') {
      if (commandBuffer.length > 0) {
        commandBuffer = commandBuffer.slice(0, -1);
        term.write('\b \b');
      }
    } else if (printable) {
      commandBuffer += ev.key;
      term.write(ev.key);
    }
  });

  // Show welcome text
  print(files['readme.txt']);
  prompt();

  // === Tabs switching logic ===
  const tabs = document.querySelectorAll('#tabs button');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const selected = tab.getAttribute('data-tab');
      tabContents.forEach(tc => {
        tc.classList.remove('active');
        if(tc.id === selected + '-container' || tc.id === selected + '-list' || tc.id === selected + '-feed' || tc.id === selected + '-tab' || tc.id === selected + '-editor') {
          tc.classList.add('active');
        }
      });
      // Special IDs in this code:
      // terminal-container, servers-list, cams-feed, phone-tab, malware-editor
      // So match these accordingly:
      // Map tab name to content id
      const map = {
        terminal: 'terminal-container',
        servers: 'servers-list',
        cams: 'cams-feed',
        phone: 'phone-tab',
        malware: 'malware-editor'
      };
      for(let key in map) {
        document.getElementById(map[key]).classList.remove('active');
      }
      document.getElementById(map[selected]).classList.add('active');
    });
  });

  // === Servers tab: show servers with live info ===
  const serversListElem = document.getElementById('servers-list');
  function renderServers() {
    let text = '';
    for (const s of Object.values(fakeServers)) {
      text += `${s.name.padEnd(18)} | Vulnerable: ${s.vulnerable ? 'YES' : 'NO '} | Camera: ${s.cameraOn ? 'ON ' : 'OFF'} | Hacked: ${s.hacked ? 'YES' : 'NO '} | Alert: ${s.alertLevel.toString().padStart(3)} | Suspicion: ${s.suspicion.toString().padStart(3)}\n`;
    }
    serversListElem.textContent = text;
  }

  setInterval(() => {
    // Simulate AI hacker behavior
    for (const s of Object.values(fakeServers)) {
      // If hacked & malware installed, alert level goes up slowly
      if (s.hacked && s.malwareInstalled) {
        s.alertLevel = Math.min(100, s.alertLevel + 1);
      }
      // Suspicion decays slowly if not observed
      s.suspicion = Math.max(0, s.suspicion - 0.5);
    }
    renderServers();
  }, 1000);

  // === Cameras tab: show fake live feeds ===
  const camsFeedElem = document.getElementById('cams-feed');
  function renderCams() {
    let text = '';
    for (const s of Object.values(fakeServers)) {
      if (s.hacked && s.cameraOn) {
        text += `=== Camera Feed: ${s.name} ===\n`;
        // Fake "live" feed, random ASCII art or text
        text += generateFakeCameraFeed(s);
        text += '\n\n';
      }
    }
    camsFeedElem.textContent = text || 'No active camera feeds. Hack a server with cameras online to view feeds.';
  }
  function generateFakeCameraFeed(server) {
    // Simple simulation of camera feed as ASCII boxes with flickering
    const frames = [
      '[██████████████]',
      '[▓▓▓▓▓▓▓▓▓▓▓▓▓▓]',
      '[▒▒▒▒▒▒▒▒▒▒▒▒▒▒]',
      '[░░░░░░░░░░░░░░]',
      '[■■■■■■■■■■■■■■]'
    ];
    const randomFrame = frames[randomInt(0, frames.length - 1)];
    return randomFrame + `\nStatus: ${server.alertLevel < 50 ? 'Normal' : 'ALERT!'}`;
  }
  setInterval(renderCams, 2000);

  // === Phone tab: simple messaging ===
  const phoneMessagesElem = document.getElementById('phone-messages');
  const phoneInputElem = document.getElementById('phone-input');
  const phoneMessages = [];

  function renderPhoneMessages() {
    phoneMessagesElem.textContent = phoneMessages.join('\n');
    phoneMessagesElem.scrollTop = phoneMessagesElem.scrollHeight;
  }
  phoneInputElem.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const msg = phoneInputElem.value.trim();
      if (msg) {
        phoneMessages.push(`[You]: ${msg}`);
        // Fake reply from AI hacker
        setTimeout(() => {
          phoneMessages.push(`[Hacker AI]: Roger that.`);
          renderPhoneMessages();
        }, 1000);
        renderPhoneMessages();
        phoneInputElem.value = '';
      }
    }
  });

  // === Malware editor: run malware code ===
  const malwareTextarea = document.getElementById('malware-textarea');
  const runMalwareBtn = document.getElementById('run-malware-btn');

  runMalwareBtn.addEventListener('click', () => {
    const code = malwareTextarea.value;
    print('\n[Running malware script...]');
    runScript(code);
  });

  // === Simple trust & FBI alert update simulation ===
  setInterval(() => {
    // FBI alert rises slowly if alertLevel on any server > 70
    let maxAlert = 0;
    for (const s of Object.values(fakeServers)) {
      if (s.alertLevel > maxAlert) maxAlert = s.alertLevel;
    }
    if (maxAlert > 70) {
      fbiAlertLevel = Math.min(100, fbiAlertLevel + 2);
    } else {
      fbiAlertLevel = Math.max(0, fbiAlertLevel - 1);
    }
    // Show FBI alert in terminal (just once every 10 seconds)
    if (Math.random() < 0.1) {
      print(`FBI Alert Level: ${fbiAlertLevel}`);
      prompt();
    }
  }, 5000);

</script>

</body>
</html>
