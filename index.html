<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cyber Secrecy</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
<style>
  html, body {
    height: 100%;
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #001000, #003300);
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    color: #00ff00;
    overflow: hidden;
  }
  #header, #footer {
    position: fixed; left: 0; width: 100vw;
    background-color: #001a00;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    text-shadow: 0 0 6px #00ff00;
    z-index: 20;
    user-select:none;
  }
  #header {
    top: 0; height: 40px;
    font-weight: bold;
    font-size: 1.5rem;
    text-align: center;
    line-height: 40px;
    border-bottom: 1px solid #00ff00;
  }
  #footer {
    bottom: 0; height: 30px;
    font-size: 0.9rem;
    text-align: center;
    line-height: 30px;
    border-top: 1px solid #00ff00;
  }

  #main {
    position: absolute;
    top: 40px; bottom: 30px; left: 0; right: 0;
    display: flex;
    flex-direction: column;
  }

  #tab-buttons {
    background: #002200;
    border-bottom: 1px solid #00ff00;
    padding: 6px 10px;
    display: flex;
    gap: 12px;
  }
  #tab-buttons button {
    background: transparent;
    border: 1.5px solid #00ff00;
    color: #00ff00;
    padding: 6px 14px;
    font-family: monospace;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.25s;
  }
  #tab-buttons button.active,
  #tab-buttons button:hover {
    background: #004400;
  }

  #content-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #050505;
    box-shadow: 0 0 20px #00ff00aa;
    color: #00ff00;
    font-family: monospace;
    display: flex;
    flex-direction: column;
  }

  /* Terminal tab */
  #terminal-tab {
    flex: 1;
  }

  /* Servers tab */
  #servers-tab {
    position: absolute;
    inset: 0;
    overflow-y: auto;
    padding: 12px;
    display: none;
  }
  #servers-tab.active {
    display: block;
  }
  #servers-list {
    max-height: 100%;
    overflow-y: auto;
  }
  .server-item {
    border: 1px solid #008800;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 4px;
    background: #003300dd;
    cursor: default;
    user-select:none;
  }
  .server-name {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 4px;
  }
  .server-status {
    font-size: 0.9rem;
    line-height: 1.3;
    white-space: pre-line;
  }
  #servers-reload {
    position: fixed;
    top: 48px;
    right: 16px;
    padding: 6px 12px;
    background: #004400;
    border: 1.5px solid #00ff00;
    border-radius: 4px;
    cursor: pointer;
    user-select:none;
    font-weight: bold;
    font-family: monospace;
  }

  /* Phone tab */
  #phone-tab {
    position: absolute;
    inset: 0;
    background: #001a00;
    display: none;
    flex-direction: column;
    color: #00ff00;
  }
  #phone-tab.active {
    display: flex;
  }
  #contacts-list {
    width: 220px;
    background: #002200;
    overflow-y: auto;
    border-right: 1px solid #00ff00;
  }
  #contacts-list .contact-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid #004400;
    cursor: pointer;
    transition: background 0.2s;
  }
  #contacts-list .contact-item:hover,
  #contacts-list .contact-item.active {
    background: #004400;
  }
  .contact-icon {
    width: 28px; height: 28px;
    background: #008800;
    border-radius: 50%;
    margin-right: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-family: monospace;
    color: #002200;
    user-select:none;
  }
  #chat-area {
    flex: 1;
    padding: 12px;
    background: #001100;
    display: flex;
    flex-direction: column;
  }
  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 6px;
    font-size: 0.95rem;
    line-height: 1.3;
  }
  .message {
    margin-bottom: 10px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .message.sent {
    align-self: flex-end;
    background: #004400;
    padding: 6px 10px;
    border-radius: 10px 10px 2px 10px;
  }
  .message.received {
    align-self: flex-start;
    background: #003300;
    padding: 6px 10px;
    border-radius: 10px 10px 10px 2px;
  }
  .msg-sender {
    font-weight: bold;
    font-size: 0.85rem;
    margin-bottom: 2px;
  }
  #chat-input {
    margin-top: 8px;
    display: flex;
  }
  #chat-input input {
    flex: 1;
    padding: 8px 12px;
    font-size: 1rem;
    font-family: monospace;
    border: none;
    outline: none;
    background: #002200;
    color: #00ff00;
    border-radius: 4px 0 0 4px;
  }
  #chat-input button {
    background: #004400;
    border: 1.5px solid #00ff00;
    border-left: none;
    padding: 8px 16px;
    font-family: monospace;
    cursor: pointer;
    border-radius: 0 4px 4px 0;
    font-weight: bold;
    color: #00ff00;
  }
  #chat-input button:hover {
    background: #005500;
  }

  /* Black Market tab */
  #blackmarket-tab {
    position: absolute;
    inset: 0;
    background: #001a00;
    color: #00ff00;
    display: none;
    flex-direction: column;
    padding: 12px;
  }
  #blackmarket-tab.active {
    display: flex;
  }
  #market-input {
    display: flex;
    margin-top: 10px;
  }
  #market-input input {
    flex: 1;
    font-family: monospace;
    font-size: 1rem;
    padding: 8px 12px;
    border-radius: 4px 0 0 4px;
    border: none;
    background: #002200;
    color: #00ff00;
    outline: none;
  }
  #market-input button {
    padding: 8px 14px;
    font-family: monospace;
    border: 1.5px solid #00ff00;
    background: #004400;
    color: #00ff00;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    font-weight: bold;
  }
  #market-input button:hover {
    background: #005500;
  }
  #data-list {
    flex: 1;
    overflow-y: auto;
    margin-top: 12px;
    border: 1px solid #00ff00;
    padding: 8px 12px;
    font-size: 0.9rem;
    white-space: pre-wrap;
  }
  #hit-board {
    margin-top: 16px;
    border-top: 1px solid #00ff00;
    padding-top: 12px;
  }
  #hit-board h3 {
    margin: 0 0 8px 0;
    font-weight: bold;
  }
  .hit-target {
    border: 1px solid #00aa00;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 4px;
    background: #003300dd;
    cursor: pointer;
    user-select:none;
  }
  .hit-target:hover {
    background: #005500dd;
  }

  /* Editor tab */
  #editor-tab {
    position: absolute;
    inset: 0;
    background: #001a00;
    display: none;
    flex-direction: column;
    padding: 12px;
    color: #00ff00;
  }
  #editor-tab.active {
    display: flex;
  }
  #code-textarea {
    flex: 1;
    width: 100%;
    background: #002200;
    border: 1.5px solid #00ff00;
    color: #00ff00;
    font-family: monospace;
    font-size: 1.2rem;
    padding: 12px;
    resize: none;
    border-radius: 6px;
    line-height: 1.4;
    outline: none;
  }
  #editor-buttons {
    margin-top: 8px;
    display: flex;
    gap: 12px;
  }
  #editor-buttons button {
    flex: 1;
    padding: 10px 0;
    font-family: monospace;
    font-size: 1rem;
    font-weight: bold;
    border-radius: 6px;
    border: 1.5px solid #00ff00;
    background: transparent;
    color: #00ff00;
    cursor: pointer;
    transition: background 0.25s;
  }
  #editor-buttons button:hover {
    background: #004400;
  }

  /* Terminal input area adjustments */
  .xterm .xterm-viewport {
    font-size: 1.1rem !important;
  }
  /* Increase input line font size */
  #terminal-container .xterm-cursor {
    font-size: 1.3rem !important;
  }
</style>
</head>
<body>

<div id="header">Cyber Secrecy</div>
<div id="main">

  <div id="tab-buttons">
    <button id="btn-terminal" class="active" title="Terminal">Terminal</button>
    <button id="btn-servers" title="Servers">Servers</button>
    <button id="btn-phone" title="Phone">Phone</button>
    <button id="btn-blackmarket" title="Black Market">Black Market</button>
    <button id="btn-editor" title="Editor">Editor</button>
  </div>

  <div id="content-area">
    <!-- Terminal -->
    <div id="terminal-tab">
      <div id="terminal-container" style="height:100%;"></div>
    </div>

    <!-- Servers -->
    <div id="servers-tab">
      <div id="servers-list"></div>
      <button id="servers-reload" title="Reload Servers">Reload</button>
    </div>

    <!-- Phone -->
    <div id="phone-tab">
      <div style="display:flex; height: 100%;">
        <div id="contacts-list"></div>
        <div id="chat-area">
          <div id="chat-messages"></div>
          <div id="chat-input">
            <input type="text" id="chat-text" placeholder="Type message..." autocomplete="off" />
            <button id="chat-send">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Black Market -->
    <div id="blackmarket-tab">
      <div>Type info to sell:</div>
      <div id="market-input">
        <input id="market-text" type="text" placeholder="Enter data or target to sell..." autocomplete="off" />
        <button id="market-sell">Sell</button>
      </div>
      <div id="data-list" readonly></div>
      <div id="hit-board">
        <h3>Hit Board (Bonus Targets)</h3>
        <div id="hit-list"></div>
      </div>
    </div>

    <!-- Editor -->
    <div id="editor-tab">
      <textarea id="code-textarea" spellcheck="false" placeholder="Write or edit your scripts here..."></textarea>
      <div id="editor-buttons">
        <button id="editor-save">Save</button>
        <button id="editor-clear">Clear</button>
      </div>
    </div>

  </div>
</div>

<div id="footer">Type "help" for commands or "edit readme.txt" to get started</div>

<script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-interpreter@latest/interpreter.js"></script>

<script>
(() => {
  const { Terminal } = window;

  // Terminal Setup
  const term = new Terminal({
    cursorBlink: true,
    scrollback: 10000,
    fontSize: 16,
    fontFamily: '"JetBrains Mono", monospace',
    theme: {
      background: '#0a0a0a',
      foreground: '#00ff00',
      cursor: '#00ff00',
      selectionBackground: 'rgba(0, 255, 0, 0.3)'
    }
  });

  term.open(document.getElementById('terminal-container'));

  // Tab controls
  const tabs = {
    terminal: document.getElementById('terminal-tab'),
    servers: document.getElementById('servers-tab'),
    phone: document.getElementById('phone-tab'),
    blackmarket: document.getElementById('blackmarket-tab'),
    editor: document.getElementById('editor-tab'),
  };

  const buttons = {
    terminal: document.getElementById('btn-terminal'),
    servers: document.getElementById('btn-servers'),
    phone: document.getElementById('btn-phone'),
    blackmarket: document.getElementById('btn-blackmarket'),
    editor: document.getElementById('btn-editor'),
  };

  function setActiveTab(tabName) {
    for (const t in tabs) {
      tabs[t].classList.toggle('active', t === tabName);
      buttons[t].classList.toggle('active', t === tabName);
    }
    if (tabName === 'terminal') {
      term.focus();
    }
    if(tabName === 'servers') {
      renderServers();
    }
    if(tabName === 'phone') {
      if (!currentContact) {
        selectContact(Object.keys(contacts)[0]);
      }
    }
    if(tabName === 'blackmarket') {
      renderHitBoard();
    }
    if(tabName === 'editor') {
      loadEditorContent(currentEditFile || 'readme.txt');
    }
  }

  Object.entries(buttons).forEach(([key, btn]) => {
    btn.onclick = () => setActiveTab(key);
  });

  setActiveTab('terminal');

  // Scroll helper
  function scrollBottom(el) {
    setTimeout(() => {
      el.scrollTop = el.scrollHeight;
    }, 0);
  }

  // Command line input handling & history
  let commandBuffer = '';
  let commandCursorPos = 0;
  let commandHistory = [];
  let historyIndex = -1;

  function refreshCommandLine() {
    // Clear current line & rewrite commandBuffer with cursor
    term.write('\x1b[2K\r'); // Clear line and carriage return
    term.write(PROMPT + commandBuffer);
    // Move cursor to the correct position:
    const cursorMove = commandBuffer.length - commandCursorPos;
    if(cursorMove > 0) term.write('\x1b[' + cursorMove + 'D');
  }

  const PROMPT = '>| ';

  // Basic filesystem and files
  const files = {
    'readme.txt': 'Welcome to Cyber Secrecy.',
  };

  // Editor current file
  let currentEditFile = 'readme.txt';

  // Terminal mode: 'command' or 'edit'
  let mode = 'command';

  // Editor mode flag (for separate big editor)
  let isEditorOpen = false;

  // AI hacker/gang contacts system
  const contacts = {};
  const gangMembers = new Set();

  // Chats, map contactName -> messages array {from:'you'|'them', text:string}
  const chats = {};

  // Hacker ranks (1 to 10)
  const hackerRanks = {};

  // FBI suspicion level (0-100)
  let fbiSuspicion = 0;

  // Black Market data store
  let blackMarketData = [];

  // Hit board targets
  let hitBoardTargets = [];

  // Servers system
  let servers = [];

  // Suspicious hacker watchlist (for ratting/pinning crimes)
  let suspiciousHackers = new Set();

  // Nyl's server special
  const NYL_SERVER_NAME = 'nyl-server-999';
  const NYL_SERVER_RANK = 999;

  // -- UTILS --

  function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }
  function generateRandomName() {
    const parts1 = ['alpha', 'beta', 'gamma', 'delta', 'sigma', 'omega', 'kappa', 'lambda', 'zeta', 'theta'];
    const parts2 = ['net', 'sys', 'io', 'com', 'org', 'tech', 'dev', 'hub', 'zone', 'cloud'];
    return randomChoice(parts1) + '-' + randomChoice(parts2) + '-' + randomInt(100, 999);
  }
  function getAlertLevelText(level) {
    if(level < 25) return 'Low';
    if(level < 50) return 'Moderate';
    if(level < 75) return 'High';
    return 'Critical';
  }

  // -- SERVER GENERATION --

  function generateServer() {
    // Random vulnerability + camera + alert + hacked + suspicious
    return {
      name: generateRandomName(),
      vulnerable: Math.random() < 0.5,
      cameraOn: Math.random() < 0.5,
      alertLevel: randomInt(0, 100),
      hacked: false,
      suspicious: 0,
    };
  }

  function generateServers(count=20) {
    servers = [];
    for(let i=0; i<count-1; i++) {
      servers.push(generateServer());
    }
    // Add special Nyl server
    servers.push({
      name: NYL_SERVER_NAME,
      vulnerable: false,
      cameraOn: false,
      alertLevel: 0,
      hacked: false,
      suspicious: 0,
      rank: NYL_SERVER_RANK,
      special: true,
    });
  }

  // -- RENDER SERVERS --

  const serversListEl = document.getElementById('servers-list');
  const serversReloadBtn = document.getElementById('servers-reload');

  function renderServers() {
    serversListEl.innerHTML = '';
    servers.forEach(srv => {
      const div = document.createElement('div');
      div.className = 'server-item';
      const rank = srv.rank || randomInt(1, 10);
      let statusLines = `Rank: ${rank}\n` +
        `Vulnerability: ${srv.vulnerable ? 'Yes' : 'No'}\n` +
        `Cameras: ${srv.cameraOn ? 'Online' : 'Offline'}\n` +
        `Alert Level: ${getAlertLevelText(srv.alertLevel)} (${srv.alertLevel})\n` +
        `Hacked: ${srv.hacked ? 'Yes' : 'No'}\n` +
        `Suspicious Activity: ${srv.suspicious}`;

      div.innerHTML = `<div class="server-name">${srv.name}</div>` +
        `<div class="server-status">${statusLines.replace(/\n/g, '<br>')}</div>`;
      serversListEl.appendChild(div);
    });
  }
  serversReloadBtn.onclick = () => {
    generateServers(20);
    renderServers();
  };
  // Initial servers
  generateServers(20);

  // -- PHONE TAB --

  const contactsListEl = document.getElementById('contacts-list');
  const chatMessagesEl = document.getElementById('chat-messages');
  const chatInputEl = document.getElementById('chat-text');
  const chatSendBtn = document.getElementById('chat-send');

  // Generate some contacts including gangs
  function generateContacts() {
    const hackerNames = ['Specter', 'Phantom', 'Ghost', 'Cipher', 'Nova', 'Rogue', 'Shade', 'Vortex', 'Glitch', 'Zero'];
    hackerNames.forEach(name => {
      contacts[name] = {
        displayName: name,
        icon: name[0],
        rank: randomInt(1, 10),
        gang: false,
      };
      chats[name] = [];
      hackerRanks[name] = contacts[name].rank;
    });

    // Create gangs with some contacts
    // Gang "Shadow Syndicate"
    const syndicateMembers = ['Specter', 'Phantom', 'Cipher'];
    syndicateMembers.forEach(m => {
      contacts[m].gang = 'Shadow Syndicate';
      gangMembers.add(m);
    });
    // Gang "Neon Reapers"
    const reapersMembers = ['Nova', 'Rogue', 'Shade'];
    reapersMembers.forEach(m => {
      contacts[m].gang = 'Neon Reapers';
      gangMembers.add(m);
    });
  }
  generateContacts();

  // Currently selected contact in phone
  let currentContact = null;

  function renderContacts() {
    contactsListEl.innerHTML = '';
    for(const name in contacts) {
      const c = contacts[name];
      const div = document.createElement('div');
      div.className = 'contact-item';
      if(name === currentContact) div.classList.add('active');
      div.dataset.name = name;
      div.innerHTML = `<div class="contact-icon">${c.icon}</div>${c.displayName}` + (c.gang ? ` <span style="font-size:0.8rem; color:#008800;">[${c.gang}]</span>` : '');
      div.onclick = () => selectContact(name);
      contactsListEl.appendChild(div);
    }
  }

  function selectContact(name) {
    currentContact = name;
    renderContacts();
    renderChat();
    chatInputEl.focus();
  }

  function renderChat() {
    chatMessagesEl.innerHTML = '';
    if (!currentContact) return;
    const msgs = chats[currentContact] || [];
    msgs.forEach(m => {
      const div = document.createElement('div');
      div.className = 'message ' + (m.from === 'you' ? 'sent' : 'received');
      div.innerHTML = `<div class="msg-sender">${m.from === 'you' ? 'You' : currentContact}</div>${m.text}`;
      chatMessagesEl.appendChild(div);
    });
    scrollBottom(chatMessagesEl);
  }

  // Handle sending messages in phone chat
  chatSendBtn.onclick = () => {
    const msg = chatInputEl.value.trim();
    if(!msg || !currentContact) return;
    addMessage(currentContact, 'you', msg);
    chatInputEl.value = '';
    renderChat();

    // Generate a reply from AI hacker after random delay if suspicious
    setTimeout(() => {
      handleAIReply(currentContact, msg);
    }, randomInt(700, 1500));
  };

  // AI replies based on message and suspicion
  function handleAIReply(contact, msg) {
    if(!contacts[contact]) return;
    // Increase suspicion randomly if message contains suspicious keywords
    const suspiciousWords = ['hack', 'trace', 'FBI', 'rat', 'spy', 'alert', 'camera', 'breach'];
    const lowered = msg.toLowerCase();
    let suspiciousInc = 0;
    suspiciousWords.forEach(w => {
      if(lowered.includes(w)) suspiciousInc += randomInt(5,15);
    });
    if(suspiciousInc > 0) {
      fbiSuspicion += suspiciousInc;
      suspiciousHackers.add(contact);
      updateFooterSuspicion();
    }
    // AI message choices vary by suspicion level
    const suspicion = fbiSuspicion;

    let replyOptions = [
      "Roger that.",
      "On it.",
      "Standing by.",
      "Got your back.",
      "Will do.",
      "Copy.",
      "Proceed with caution.",
      "I'm watching the cams.",
      "Quiet on your end?",
      "Anything unusual?"
    ];

    if(suspicion > 70) {
      replyOptions.push("FBI might be onto us, be careful.");
      replyOptions.push("Lay low, things are heating up.");
      replyOptions.push("Too much noise lately.");
    }

    if(suspicion > 90) {
      replyOptions.push("They're closing in! Disconnect if you can!");
      replyOptions.push("I got eyes on you, don't slip up.");
    }

    // Sometimes AI 'rats' if player hacks the dev server or suspicious
    if(contact === 'Specter' && suspicion > 85 && Math.random() < 0.3) {
      replyOptions.push("I've been compromised! They're onto you!");
      // Could add extra game logic for ratting out
    }

    const reply = randomChoice(replyOptions);
    addMessage(contact, 'them', reply);
    renderChat();
  }

  // Add message helper
  function addMessage(contact, from, text) {
    if(!chats[contact]) chats[contact] = [];
    chats[contact].push({from, text});
  }

  renderContacts();

  // -- BLACK MARKET --

  const marketTextEl = document.getElementById('market-text');
  const marketSellBtn = document.getElementById('market-sell');
  const dataListEl = document.getElementById('data-list');
  const hitListEl = document.getElementById('hit-list');

  // Data store for selling
  blackMarketData = [];

  // Add sell data
  marketSellBtn.onclick = () => {
    const data = marketTextEl.value.trim();
    if(!data) return alert('Enter data or hit target to sell.');

    // Evaluate price based on keywords
    let basePrice = 10;
    if(data.toLowerCase().includes('password')) basePrice += 50;
    if(data.toLowerCase().includes('credit')) basePrice += 40;
    if(data.toLowerCase().includes('server')) basePrice += 30;
    if(data.toLowerCase().includes('hack')) basePrice += 20;
    if(data.toLowerCase().includes(NYL_SERVER_NAME)) {
      alert("You cannot sell info on Nyl's server!");
      marketTextEl.value = '';
      return;
    }

    // Add data with price to black market
    blackMarketData.push({data, price: basePrice});
    renderBlackMarketData();
    marketTextEl.value = '';
  };

  function renderBlackMarketData() {
    if(blackMarketData.length === 0) {
      dataListEl.textContent = '(No data sold yet)';
      return;
    }
    let out = '';
    blackMarketData.forEach((d,i) => {
      out += `[${i+1}] Data: ${d.data} - Price: $${d.price}\n`;
    });
    dataListEl.textContent = out;
  }

  // Hit board targets: generate from servers vulnerable & not hacked
  function renderHitBoard() {
    hitListEl.innerHTML = '';
    const hits = servers.filter(s => s.vulnerable && !s.hacked && !s.special).slice(0,5);
    hits.forEach(hit => {
      const div = document.createElement('div');
      div.className = 'hit-target';
      div.textContent = `${hit.name} [Alert: ${getAlertLevelText(hit.alertLevel)}]`;
      div.onclick = () => {
        // Selling hit target info for bonus
        const price = 100 + hit.alertLevel;
        blackMarketData.push({data: `Hit contract on ${hit.name}`, price});
        alert(`Hit contract for ${hit.name} purchased for $${price}!`);
        renderBlackMarketData();
      };
      hitListEl.appendChild(div);
    });
  }

  // Initial render
  renderBlackMarketData();
  renderHitBoard();

  // -- EDITOR --

  const editorTextarea = document.getElementById('code-textarea');
  const editorSaveBtn = document.getElementById('editor-save');
  const editorClearBtn = document.getElementById('editor-clear');

  function loadEditorContent(filename) {
    if(files[filename] === undefined) {
      files[filename] = '';
    }
    editorTextarea.value = files[filename];
    currentEditFile = filename;
  }
  editorSaveBtn.onclick = () => {
    files[currentEditFile] = editorTextarea.value;
    alert(`Saved ${currentEditFile}`);
  };
  editorClearBtn.onclick = () => {
    if(confirm('Clear all text?')) {
      editorTextarea.value = '';
    }
  };

  // -- TERMINAL COMMANDS --

  function listFiles() {
    const names = Object.keys(files);
    print(names.length ? names.join('  ') : '(no files)');
  }

  function catFile(filename) {
    print(filename in files ? files[filename] : `cat: no such file: ${filename}`);
  }

  function editFile(filename) {
    if(!(filename in files)) {
      files[filename] = '';
    }
    currentEditFile = filename;
    loadEditorContent(filename);
    setActiveTab('editor');
  }

  // Run file interpreter
  function runFile(filename) {
    if (!(filename in files)) {
      print(`run: no such file: ${filename}`);
      prompt();
      return;
    }
    print(`Running ${filename}...`);
    const interpreter = new Interpreter(files[filename], function(interpreter, globalObject) {
      interpreter.setProperty(globalObject, 'print',
        interpreter.createNativeFunction(function(text) {
          print(String(text));
        })
      );
      interpreter.setProperty(globalObject, 'scan',
        interpreter.createNativeFunction(function() {
          return servers.map(s=>s.name).join('\n');
        })
      );
      interpreter.setProperty(globalObject, 'probe',
        interpreter.createNativeFunction(function(server) {
          server = String(server);
          const srv = servers.find(s => s.name === server);
          if(!srv) return 'UNKNOWN HOST';
          return srv.vulnerable ? 'VULNERABLE' : 'SECURE';
        })
      );
      interpreter.setProperty(globalObject, 'cameraStatus',
        interpreter.createNativeFunction(function(server) {
          server = String(server);
          const srv = servers.find(s => s.name === server);
          if(!srv) return 'UNKNOWN HOST';
          return srv.cameraOn ? 'ONLINE' : 'OFFLINE';
        })
      );
      interpreter.setProperty(globalObject, 'hack',
        interpreter.createNativeFunction(function(server) {
          server = String(server);
          const srv = servers.find(s => s.name === server);
          if(!srv) return 'FAIL: NO HOST';
          if(srv.special) {
            // Nyl's server hacked attempt triggers FBI and ratting
            fbiSuspicion = 100;
            suspiciousHackers.forEach(h => {
              addMessage(h, 'them', "The dev's server was targeted! We're being watched!");
            });
            updateFooterSuspicion();
            return 'ACCESS DENIED: DEV SERVER';
          }
          if(srv.vulnerable) {
            srv.hacked = true;
            return `SUCCESS: Hacked ${server}`;
          } else {
            return `FAIL: ${server} NOT VULNERABLE`;
          }
        })
      );
    });

    try {
      interpreter.run();
    } catch(e) {
      print(`Error: ${e.message}`);
    }
    prompt();
  }

  // Terminal print wrapper
  function print(text) {
    term.writeln(text);
  }

  // Terminal prompt
  function prompt() {
    term.write(PROMPT);
  }

  // Parse & execute terminal commands
  function handleCommand(line) {
    const args = line.trim().split(/\s+/);
    if(!args.length) {
      prompt();
      return;
    }
    const cmd = args[0].toLowerCase();

    switch(cmd) {
      case 'help':
        print(`Available commands: help, ls, cat, edit, run, clear, exit`);
        prompt();
        break;
      case 'ls':
        listFiles();
        prompt();
        break;
      case 'cat':
        if(args.length < 2) {
          print('cat: filename required');
          prompt();
        } else {
          catFile(args[1]);
          prompt();
        }
        break;
      case 'edit':
        if(args.length < 2) {
          print('edit: filename required');
          prompt();
        } else {
          editFile(args[1]);
        }
        break;
      case 'run':
        if(args.length < 2) {
          print('run: filename required');
          prompt();
        } else {
          runFile(args[1]);
        }
        break;
      case 'clear':
        term.clear();
        prompt();
        break;
      case 'exit':
        print('Exiting Cyber Secrecy. Reload page to restart.');
        term.write('');
        break;
      default:
        print(`Unknown command: ${cmd}`);
        prompt();
        break;
    }
  }

  // Terminal input handling with history and cursor support
  term.promptBuffer = '';
  term.cursorPos = 0;

  term.onKey(e => {
    const ev = e.domEvent;
    const printable = !ev.altKey && !ev.ctrlKey && !ev.metaKey;

    if (ev.key === 'Backspace') {
      if (term.cursorPos > 0) {
        term.promptBuffer = term.promptBuffer.slice(0, term.cursorPos - 1) + term.promptBuffer.slice(term.cursorPos);
        term.cursorPos--;
        refreshCommandLine();
      }
    } else if (ev.key === 'Delete') {
      if (term.cursorPos < term.promptBuffer.length) {
        term.promptBuffer = term.promptBuffer.slice(0, term.cursorPos) + term.promptBuffer.slice(term.cursorPos + 1);
        refreshCommandLine();
      }
    } else if (ev.key === 'ArrowLeft') {
      if (term.cursorPos > 0) {
        term.cursorPos--;
        term.write('\x1b[D');
      }
    } else if (ev.key === 'ArrowRight') {
      if (term.cursorPos < term.promptBuffer.length) {
        term.cursorPos++;
        term.write('\x1b[C');
      }
    } else if (ev.key === 'ArrowUp') {
      if (commandHistory.length === 0) return;
      if (historyIndex < commandHistory.length - 1) historyIndex++;
      term.promptBuffer = commandHistory[commandHistory.length - 1 - historyIndex];
      term.cursorPos = term.promptBuffer.length;
      refreshCommandLine();
    } else if (ev.key === 'ArrowDown') {
      if (historyIndex > 0) {
        historyIndex--;
        term.promptBuffer = commandHistory[commandHistory.length - 1 - historyIndex];
      } else {
        historyIndex = -1;
        term.promptBuffer = '';
      }
      term.cursorPos = term.promptBuffer.length;
      refreshCommandLine();
    } else if (ev.key === 'Enter') {
      term.writeln('');
      if (term.promptBuffer.trim() !== '') {
        commandHistory.push(term.promptBuffer);
      }
      historyIndex = -1;
      handleCommand(term.promptBuffer);
      term.promptBuffer = '';
      term.cursorPos = 0;
    } else if (printable) {
      term.promptBuffer = term.promptBuffer.slice(0, term.cursorPos) + e.key + term.promptBuffer.slice(term.cursorPos);
      term.cursorPos++;
      refreshCommandLine();
    }
  });

  prompt();

  // -- UI helper for suspicion display in footer --
  function updateFooterSuspicion() {
    const footer = document.getElementById('footer');
    if (fbiSuspicion > 75) {
      footer.style.color = '#ff2200';
      footer.textContent = `FBI Suspicion Level: ${fbiSuspicion} - HIGH! Lay low!`;
    } else if (fbiSuspicion > 40) {
      footer.style.color = '#ffff00';
      footer.textContent = `FBI Suspicion Level: ${fbiSuspicion} - Moderate caution advised.`;
    } else {
      footer.style.color = '#00ff00';
      footer.textContent = `FBI Suspicion Level: ${fbiSuspicion} - All clear.`;
    }
  }

  updateFooterSuspicion();

  // -- Initial selection --
  selectContact(Object.keys(contacts)[0]);

})();
</script>

</body>
</html>
