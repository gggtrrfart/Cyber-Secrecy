<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hyper-Realistic Hacker Simulator (HackerSim v1.0)</title>
<style>
  /* --- Reset & Base --- */
  * {
    box-sizing: border-box;
  }
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    background: linear-gradient(135deg, #2d6ca2 0%, #63a7f0 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #ddd;
    user-select: none;
    overflow: hidden;
  }
  a {
    color: #0ff;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  /* --- Container --- */
  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100vw;
    background: #0f1c3f;
    box-shadow:
      inset 0 0 40px #3aa3ff88,
      inset 0 0 80px #44b1ffaa;
  }
  /* --- Top Bar --- */
  #topbar {
    flex-shrink: 0;
    height: 50px;
    background: linear-gradient(90deg, #00509e, #0086ff);
    display: flex;
    align-items: center;
    padding: 0 20px;
    box-shadow: 0 3px 10px #004a7e99;
    user-select: none;
  }
  #logo {
    font-weight: 900;
    font-size: 28px;
    color: #00e0ff;
    text-shadow:
      0 0 5px #00e0ff,
      0 0 10px #00e0ff,
      0 0 20px #00e0ff;
    cursor: default;
    margin-right: 30px;
  }
  #tabs {
    display: flex;
    gap: 12px;
  }
  .tab {
    padding: 8px 18px;
    font-weight: 600;
    font-size: 15px;
    background: rgba(0,0,0,0.25);
    border-radius: 8px 8px 0 0;
    color: #99ccff;
    cursor: pointer;
    transition:
      background 0.3s ease,
      color 0.3s ease;
  }
  .tab:hover {
    background: rgba(0,0,0,0.4);
    color: #00e0ff;
  }
  .tab.active {
    background: #00cfff;
    color: #00202e;
    box-shadow: 0 5px 15px #00cfff99;
  }

  /* --- Content Area --- */
  #content {
    flex-grow: 1;
    display: flex;
    position: relative;
    background: #061b37;
    box-shadow:
      inset 0 0 40px #00bfff44,
      inset 0 0 70px #0057a2cc;
    overflow: hidden;
  }

  /* --- Panels --- */
  .panel {
    display: none;
    width: 100%;
    height: 100%;
    padding: 15px 20px;
    color: #aaffff;
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #00bfff88 #003050;
  }
  .panel.active {
    display: block;
  }
  /* Scrollbar style */
  .panel::-webkit-scrollbar {
    width: 12px;
  }
  .panel::-webkit-scrollbar-track {
    background: #00203b;
    border-radius: 8px;
  }
  .panel::-webkit-scrollbar-thumb {
    background: #00bfffaa;
    border-radius: 8px;
  }
  .panel::-webkit-scrollbar-thumb:hover {
    background: #00d0ffdd;
  }

  /* === TERMINAL PANEL === */
  #terminal {
    background: #000;
    color: #0f0;
    box-shadow:
      inset 0 0 15px #00ff0044,
      inset 0 0 35px #00ff0055;
    font-size: 16px;
    line-height: 1.35em;
    padding: 20px;
    white-space: pre-wrap;
  }
  #terminal-input {
    width: 100%;
    background: #001000cc;
    border: none;
    outline: none;
    color: #0f0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    padding: 8px 14px;
    margin-top: 8px;
    border-radius: 6px;
    box-shadow: 0 0 10px #00ff0044 inset;
    caret-color: #0f0;
  }
  #terminal-input::placeholder {
    color: #005500aa;
  }

  /* === SERVERS PANEL === */
  #servers {
    display: flex;
    gap: 20px;
  }
  #servers-list {
    flex: 1 1 280px;
    background: #09253e;
    border-radius: 8px;
    overflow-y: auto;
    box-shadow: 0 0 20px #00aaff44 inset;
  }
  #servers-list li {
    padding: 12px 14px;
    border-bottom: 1px solid #004970aa;
    cursor: pointer;
    transition: background 0.3s ease;
    user-select: none;
  }
  #servers-list li:hover {
    background: #00b3ff22;
  }
  #servers-list li.active {
    background: #0099ff44;
    color: #cceeff;
  }
  #server-details {
    flex: 2 1 auto;
    background: #0a3b66;
    border-radius: 8px;
    padding: 18px;
    box-shadow:
      inset 0 0 25px #0099ff44;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.4em;
  }

  /* === EDITOR PANEL === */
  #editor {
    display: flex;
    flex-direction: column;
  }
  #editor-textarea {
    flex-grow: 1;
    background: #0b254a;
    border: none;
    border-radius: 8px;
    color: #aaffcc;
    font-family: 'JetBrains Mono', monospace;
    font-size: 17px;
    padding: 20px;
    resize: none;
    box-shadow: inset 0 0 25px #33ffaa88;
    outline: none;
    line-height: 1.5em;
  }
  #run-script-btn {
    margin-top: 12px;
    padding: 12px 20px;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
    font-size: 17px;
    background: #004422;
    border: none;
    color: #aaffcc;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #run-script-btn:hover {
    background: #007733;
    box-shadow: 0 0 15px #00ffbbbb;
  }

  /* === PHONE PANEL === */
  #phone-contacts {
    max-height: 40%;
    overflow-y: auto;
    background: #0c1c2a;
    border-radius: 8px;
    padding: 10px;
    user-select: none;
    box-shadow: inset 0 0 15px #0099ffaa;
  }
  #phone-contacts li {
    padding: 10px 14px;
    border-bottom: 1px solid #003355aa;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #phone-contacts li:hover {
    background: #0055aa33;
  }
  #phone-contacts li.active {
    background: #0077ff66;
    color: #ccddff;
  }
  #phone-chat {
    flex-grow: 1;
    margin-top: 14px;
    background: #002a55;
    border-radius: 8px;
    padding: 14px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 15px;
    line-height: 1.4em;
    color: #aaddff;
  }
  #phone-input {
    width: 100%;
    margin-top: 10px;
    padding: 12px 16px;
    border-radius: 8px;
    border: none;
    outline: none;
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    color: #eef;
    background: #004477cc;
    box-shadow: inset 0 0 10px #0066ffbb;
  }
  #phone-input::placeholder {
    color: #6699ccaa;
  }

  /* === BLACK MARKET PANEL === */
  #blackmarket-list {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    padding-top: 8px;
  }
  .blackmarket-item {
    flex: 0 0 180px;
    background: #2a004d;
    border-radius: 12px;
    padding: 14px 18px;
    cursor: pointer;
    user-select: none;
    color: #ddbbee;
    box-shadow: 0 0 15px #aa55ffcc inset;
    transition: background 0.3s ease;
  }
  .blackmarket-item:hover {
    background: #4410aa;
  }
  .blackmarket-item h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    text-shadow: 0 0 4px #d0baffcc;
  }
  .blackmarket-item p {
    font-size: 14px;
    margin: 0;
  }

  /* === SETTINGS PANEL === */
  #settings label {
    display: block;
    margin-bottom: 18px;
    font-size: 15px;
    color: #aaddee;
  }
  #settings input[type=range] {
    width: 100%;
    margin-top: 6px;
  }
  #settings select {
    margin-top: 6px;
    padding: 6px 10px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  /* === TOOLTIP STYLE === */
  .tooltip {
    position: relative;
    cursor: help;
  }
  .tooltip:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translate(-50%, -8px);
    background: #001833cc;
    color: #aaffff;
    padding: 6px 10px;
    border-radius: 6px;
    white-space: nowrap;
    font-size: 13px;
    pointer-events: none;
    opacity: 1;
    transition: opacity 0.2s ease;
    box-shadow: 0 0 10px #00bbffbb;
    z-index: 1000;
  }
  .tooltip::after {
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  /* --- Animations --- */
  .button-hover-fade:hover {
    animation: glowPulse 1.2s infinite alternate;
  }
  @keyframes glowPulse {
    0% {
      box-shadow: 0 0 8px #00ccffaa;
    }
    100% {
      box-shadow: 0 0 20px #00ccffee;
    }
  }

</style>
</head>
<body>
<div id="app" role="main" aria-label="Hyper-Realistic Hacker Simulator Application">
  <div id="topbar" role="navigation" aria-label="Main Navigation Bar">
    <div id="logo" tabindex="0" aria-label="HackerSim Logo">&#x1F576; HackerSim</div>
    <nav id="tabs" role="tablist" aria-label="Primary Tabs">
      <div class="tab active" role="tab" aria-selected="true" tabindex="0" data-tab="terminal" id="tab-terminal">Terminal</div>
      <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="servers" id="tab-servers">Servers</div>
      <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="editor" id="tab-editor">Editor</div>
      <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="phone" id="tab-phone">Phone</div>
      <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="blackmarket" id="tab-blackmarket">Black Market</div>
      <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-tab="settings" id="tab-settings">Settings</div>
    </nav>
  </div>

  <section id="content" tabindex="0">
    <article id="terminal" class="panel active" role="tabpanel" aria-labelledby="tab-terminal" tabindex="0" aria-live="polite" aria-relevant="additions">
      <pre id="terminal-output" style="white-space: pre-wrap;"></pre>
      <input id="terminal-input" aria-label="Terminal Command Input" placeholder="Enter command..." autocomplete="off" />
    </article>

    <article id="servers" class="panel" role="tabpanel" aria-labelledby="tab-servers" tabindex="0">
      <ul id="servers-list" role="list" aria-label="List of known servers"></ul>
      <pre id="server-details" aria-live="polite" aria-atomic="true">Select a server from the list to view details...</pre>
    </article>

    <article id="editor" class="panel" role="tabpanel" aria-labelledby="tab-editor" tabindex="0" aria-label="Code Editor">
      <textarea id="editor-textarea" spellcheck="false" aria-label="Terminus Script Editor" placeholder="// Write your Terminus (.t) script here..."></textarea>
      <button id="run-script-btn" class="button-hover-fade" aria-label="Run Script Button">Run Script</button>
    </article>

    <article id="phone" class="panel" role="tabpanel" aria-labelledby="tab-phone" tabindex="0">
      <ul id="phone-contacts" role="list" aria-label="Phone contacts"></ul>
      <div id="phone-chat" aria-live="polite" aria-atomic="false"></div>
      <input id="phone-input" type="text" aria-label="Phone chat input" placeholder="Type a message... Press Enter to send" autocomplete="off" />
    </article>

    <article id="blackmarket" class="panel" role="tabpanel" aria-labelledby="tab-blackmarket" tabindex="0" aria-label="Black Market Store">
      <div id="blackmarket-list" aria-live="polite"></div>
    </article>

    <article id="settings" class="panel" role="tabpanel" aria-labelledby="tab-settings" tabindex="0" aria-label="Settings">
      <label>
        Resolution:
        <select id="setting-resolution" aria-label="Screen resolution settings">
          <option value="default">Default (Fullscreen)</option>
          <option value="1280x720">1280×720</option>
          <option value="1920x1080" selected>1920×1080</option>
          <option value="2560x1440">2560×1440</option>
        </select>
      </label>
      <label>
        Volume:
        <input type="range" id="setting-volume" min="0" max="100" value="60" aria-valuemin="0" aria-valuemax="100" aria-valuenow="60" aria-label="Volume control slider" />
      </label>
      <label>
        Terminal Color Scheme:
        <select id="setting-terminal-color" aria-label="Terminal color scheme settings">
          <option value="green" selected>Green</option>
          <option value="blue">Blue</option>
          <option value="cyan">Cyan</option>
          <option value="purple">Purple</option>
        </select>
      </label>
    </article>
  </section>
</div>

<script>
(() => {
  "use strict";

  // --- Global Game State ---
  const state = {
    playerName: null,
    serverName: null,
    servers: {}, // serverName => {owner, ip, cpu, firewallLevel, malware, dataValue, ...}
    players: {}, // playerName => {currentServer, malware, cpuUsage, friends, screenSharing, malwareProtection, ...}
    logs: [],
    currentTab: "terminal",
    terminalHistory: [],
    terminalHistoryIndex: 0,
    currentServer: null,
    malwareScripts: {}, // stored malware scripts by player
    runningScripts: {}, // currently running scripts
    blackMarketItems: [],
    phoneContacts: [],
    phoneChats: {}, // playerName => [messages]
    settings: {
      resolution: "1920x1080",
      volume: 60,
      terminalColor: "green",
    },
    cpuMax: 100, // max CPU units for each player
    malwareDetectionMessages: [
      "Potential data breach detected.",
      "Unusual activity detected in firewall logs.",
      "Suspicious process flagged.",
      "Firewall alert: Possible intrusion attempt.",
    ],
  };

  // --- UTILS ---

  function $(id) { return document.getElementById(id); }
  function createEl(tag, opts = {}) {
    const el = document.createElement(tag);
    if (opts.cls) el.className = opts.cls;
    if (opts.text) el.textContent = opts.text;
    if (opts.html) el.innerHTML = opts.html;
    if (opts.attrs) {
      for (const [k,v] of Object.entries(opts.attrs)) el.setAttribute(k,v);
    }
    if (opts.events) {
      for (const [k,v] of Object.entries(opts.events)) el.addEventListener(k,v);
    }
    return el;
  }
  function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  function clamp(num, min, max) {
    return Math.min(Math.max(num, min), max);
  }

  // --- UI TAB HANDLER ---
  const tabs = document.querySelectorAll("#tabs .tab");
  const panels = document.querySelectorAll(".panel");

  function switchTab(tabName) {
    state.currentTab = tabName;
    tabs.forEach(t => {
      if (t.dataset.tab === tabName) {
        t.classList.add("active");
        t.setAttribute("aria-selected", "true");
        t.tabIndex = 0;
      } else {
        t.classList.remove("active");
        t.setAttribute("aria-selected", "false");
        t.tabIndex = -1;
      }
    });
    panels.forEach(p => {
      if (p.id === tabName) {
        p.classList.add("active");
        p.setAttribute("aria-hidden", "false");
      } else {
        p.classList.remove("active");
        p.setAttribute("aria-hidden", "true");
      }
    });
    // Focus first element in panel if applicable
    setTimeout(() => {
      const panel = $(`#${tabName}`);
      if (panel) panel.focus();
    }, 100);
  }

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      switchTab(tab.dataset.tab);
    });
    tab.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        switchTab(tab.dataset.tab);
      }
    });
  });

  // --- TERMINAL LOGIC ---

  const terminalOutput = $("terminal-output");
  const terminalInput = $("terminal-input");

  function logToTerminal(text, type = "info") {
    const timeStr = new Date().toLocaleTimeString();
    const prefix = `[${timeStr}] `;
    // Color code by type?
    let color = "#0f0";
    if (type === "error") color = "#f55";
    else if (type === "warn") color = "#ff5";
    else if (type === "system") color = "#0af";
    const line = createEl("div");
    line.style.color = color;
    line.textContent = prefix + text;
    terminalOutput.appendChild(line);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  }

  // For simulating slow typing on terminal output (e.g. screen share logs)
  async function terminalTypeLine(line, delay = 30) {
    const timeStr = new Date().toLocaleTimeString();
    const prefix = `[${timeStr}] `;
    const lineDiv = createEl("div");
    terminalOutput.appendChild(lineDiv);
    for (let i = 0; i < prefix.length; i++) {
      lineDiv.textContent += prefix[i];
      await sleep(delay);
    }
    for (let i = 0; i < line.length; i++) {
      lineDiv.textContent += line[i];
      await sleep(delay + (Math.random() * 20));
    }
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  }

  // --- PLAYER & SERVER SETUP ---

  function createPlayer(name) {
    if (state.players[name]) return false; // already exists
    state.players[name] = {
      name,
      serverName: name + "'s Server",
      currentServer: name + "'s Server",
      cpuUsage: 0,
      malwareProtection: false,
      malwareInstalled: false,
      malwareScripts: [],
      screenSharingWith: null,
      funds: 1000,
      dataStolen: 0,
      blackMarketPurchased: [],
      reportsAgainst: 0,
      kicked: false,
    };
    createServer(state.players[name].serverName, name);
    return true;
  }
  function createServer(serverName, owner) {
    if (state.servers[serverName]) return false;
    state.servers[serverName] = {
      name: serverName,
      owner,
      ip: `192.168.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,
      cpuMax: 100,
      cpuUsed: 0,
      firewallLevel: 1,
      malwareInstalled: false,
      dataValue: Math.floor(Math.random()*1000) + 500,
      malwareScripts: [],
      logs: [],
      playersConnected: [],
      location: randomChoice([
        {city:"Chicago", coords:[41.8781, -87.6298]},
        {city:"New York", coords:[40.7128, -74.0060]},
        {city:"San Francisco", coords:[37.7749, -122.4194]},
        {city:"Seattle", coords:[47.6062, -122.3321]},
        {city:"Boston", coords:[42.3601, -71.0589]},
      ]),
    };
    return true;
  }

  // --- INITIAL PLAYER & SERVER SETUP ---

  // Player is "You"
  const playerName = "You";
  createPlayer(playerName);

  // Create some NPC players and servers for multiplayer feel
  ["Alice", "Bob", "Charlie", "Delta"].forEach(npc => {
    createPlayer(npc);
  });

  // Link players connected to servers
  Object.values(state.players).forEach(p => {
    const s = state.servers[p.serverName];
    if (s && !s.playersConnected.includes(p.name)) {
      s.playersConnected.push(p.name);
    }
  });

  state.currentServer = state.players[playerName].currentServer;

  // --- DISPLAY SERVERS LIST ---

  const serversList = $("servers-list");
  const serverDetails = $("server-details");

  function renderServersList() {
    serversList.innerHTML = "";
    Object.values(state.servers).forEach(server => {
      const li = createEl("li", {
        text: `${server.name} (${server.ip})`,
        attrs: {tabindex: "0"},
      });
      li.dataset.serverName = server.name;
      li.title = `Owner: ${server.owner}, Firewall Level: ${server.firewallLevel}, Data Value: $${server.dataValue}`;
      li.addEventListener("click", () => {
        selectServer(server.name);
      });
      li.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          selectServer(server.name);
          e.preventDefault();
        }
      });
      serversList.appendChild(li);
    });
  }
  function selectServer(serverName) {
    Object.querySelectorAll?.(`#servers-list li`).forEach(li => li.classList.remove("active"));
    const lis = serversList.querySelectorAll("li");
    lis.forEach(li => {
      if (li.dataset.serverName === serverName) li.classList.add("active");
    });
    state.currentServer = serverName;
    const server = state.servers[serverName];
    if (!server) {
      serverDetails.textContent = "Unknown server.";
      return;
    }
    const info = 
`Server: ${server.name}
Owner: ${server.owner}
IP Address: ${server.ip}
CPU Usage: ${server.cpuUsed} / ${server.cpuMax}
Firewall Level: ${server.firewallLevel}
Malware Installed: ${server.malwareInstalled ? "Yes" : "No"}
Data Value: $${server.dataValue}
Players Connected: ${server.playersConnected.join(", ")}
Location: ${server.location.city} (${server.location.coords[0].toFixed(2)}, ${server.location.coords[1].toFixed(2)})`;

    serverDetails.textContent = info;
  }

  // --- TERMINAL COMMANDS ---

  const terminalCommands = {
    help() {
      return `Available commands:
  help - Show this message
  servers - List known servers
  scan [server] - Scan a server for info
  connect [server] - Connect to a server
  disconnect - Disconnect from current server
  run [script.t] - Run a Terminus script
  malware - Show malware status
  stats - Show your status
  clear - Clear terminal screen
  exit - Close the terminal (switch to editor)
`;
    },
    servers() {
      const serverNames = Object.keys(state.servers);
      if (serverNames.length === 0) return "No servers found.";
      return "Known servers:\n" + serverNames.map(s => `- ${s}`).join("\n");
    },
    scan(args) {
      if (!args.length) return "Usage: scan [server]";
      const serverName = args[0];
      const server = state.servers[serverName];
      if (!server) return `Server '${serverName}' not found.`;
      return `Scan result for '${serverName}':
IP: ${server.ip}
CPU Usage: ${server.cpuUsed} / ${server.cpuMax}
Firewall Level: ${server.firewallLevel}
Malware Installed: ${server.malwareInstalled ? "Yes" : "No"}
Data Value: $${server.dataValue}`;
    },
    connect(args) {
      if (!args.length) return "Usage: connect [server]";
      const serverName = args[0];
      if (!state.servers[serverName]) return `Server '${serverName}' not found.`;
      state.currentServer = serverName;
      return `Connected to '${serverName}'.`;
    },
    disconnect() {
      state.currentServer = null;
      return "Disconnected from server.";
    },
    run(args) {
      if (!args.length) return "Usage: run [script.t]";
      const scriptName = args[0];
      if (!state.malwareScripts[scriptName]) return `Script '${scriptName}' not found in your scripts.`;
      runTerminusScript(scriptName);
      return `Running script '${scriptName}'...`;
    },
    malware() {
      const player = state.players[playerName];
      if (!player.malwareInstalled) return "You have no malware installed.";
      return `Malware Status:
  Installed: Yes
  CPU Usage: ${player.cpuUsage} / ${state.cpuMax}
  Scripts Running: ${player.malwareScripts.length}
  Funds: $${player.funds.toFixed(2)}`;
    },
    stats() {
      const player = state.players[playerName];
      return `Player Stats:
  Name: ${player.name}
  Current Server: ${player.currentServer}
  Malware Protection: ${player.malwareProtection ? "Enabled" : "Disabled"}
  Funds: $${player.funds.toFixed(2)}
  Data Stolen: $${player.dataStolen.toFixed(2)}
  Reports Against You: ${player.reportsAgainst}
  Kicked: ${player.kicked ? "Yes" : "No"}`;
    },
    clear() {
      terminalOutput.innerHTML = "";
      return "";
    },
    exit() {
      switchTab("editor");
      return "";
    },
  };

  async function handleTerminalCommand(commandLine) {
    logToTerminal(`> ${commandLine}`, "system");
    if (!commandLine.trim()) return;
    const parts = commandLine.trim().split(/\s+/);
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1);
    if (!terminalCommands[cmd]) {
      logToTerminal(`Command not found: ${cmd}`, "error");
      return;
    }
    try {
      const result = await terminalCommands[cmd](args);
      if (result) logToTerminal(result, "info");
    } catch (e) {
      logToTerminal("Error running command: " + e.message, "error");
    }
  }

  terminalInput.addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      const cmd = terminalInput.value;
      state.terminalHistory.push(cmd);
      state.terminalHistoryIndex = state.terminalHistory.length;
      terminalInput.value = "";
      await handleTerminalCommand(cmd);
    } else if (e.key === "ArrowUp") {
      if (state.terminalHistoryIndex > 0) {
        state.terminalHistoryIndex--;
        terminalInput.value = state.terminalHistory[state.terminalHistoryIndex] || "";
      }
      e.preventDefault();
    } else if (e.key === "ArrowDown") {
      if (state.terminalHistoryIndex < state.terminalHistory.length - 1) {
        state.terminalHistoryIndex++;
        terminalInput.value = state.terminalHistory[state.terminalHistoryIndex] || "";
      } else {
        state.terminalHistoryIndex = state.terminalHistory.length;
        terminalInput.value = "";
      }
      e.preventDefault();
    }
  });

  // --- TERMINUS SCRIPT ENGINE ---

  // Terminus is a simple scripting language
  // Commands: wait [ms], print [text], cpu [amount], infect [server], stealth [level]
  // This is a simple interpreter that runs asynchronously

  async function runTerminusScript(scriptName) {
    const player = state.players[playerName];
    const script = state.malwareScripts[scriptName];
    if (!script) {
      logToTerminal(`Script '${scriptName}' not found.`, "error");
      return;
    }
    logToTerminal(`Executing Terminus script: ${scriptName}`, "system");
    const lines = script.split("\n").map(l => l.trim()).filter(l => l.length && !l.startsWith("//"));
    for (const line of lines) {
      const parts = line.split(/\s+/);
      const cmd = parts[0].toLowerCase();
      const args = parts.slice(1);
      try {
        switch (cmd) {
          case "wait": {
            const ms = parseInt(args[0]) || 1000;
            await sleep(ms);
            break;
          }
          case "print": {
            const text = args.join(" ");
            logToTerminal(text, "system");
            break;
          }
          case "cpu": {
            const amount = parseInt(args[0]) || 1;
            player.cpuUsage = clamp(player.cpuUsage + amount, 0, state.cpuMax);
            logToTerminal(`CPU usage increased by ${amount}. Current usage: ${player.cpuUsage}`, "warn");
            break;
          }
          case "infect": {
            const target = args[0];
            if (!state.servers[target]) {
              logToTerminal(`Target server '${target}' does not exist.`, "error");
            } else {
              const server = state.servers[target];
              if (!server.malwareInstalled) {
                server.malwareInstalled = true;
                logToTerminal(`Successfully infected server '${target}'.`, "info");
                player.dataStolen += server.dataValue * 0.1;
                player.funds += server.dataValue * 0.15;
              } else {
                logToTerminal(`Server '${target}' is already infected.`, "warn");
              }
            }
            break;
          }
          case "stealth": {
            const lvl = parseInt(args[0]) || 1;
            logToTerminal(`Stealth mode set to level ${lvl}.`, "info");
            break;
          }
          default:
            logToTerminal(`Unknown Terminus command: ${cmd}`, "error");
        }
        await sleep(200);
      } catch (e) {
        logToTerminal(`Error in script: ${e.message}`, "error");
      }
    }
    logToTerminal(`Terminus script '${scriptName}' execution completed.`, "system");
  }

  // --- SCRIPT EDITOR & STORAGE ---

  const editorTextarea = $("editor-textarea");
  const runScriptBtn = $("run-script-btn");

  runScriptBtn.addEventListener("click", () => {
    const scriptText = editorTextarea.value.trim();
    if (!scriptText) {
      alert("Please enter a Terminus script before running.");
      return;
    }
    // For now, store under "myscript.t"
    const scriptName = "myscript.t";
    state.malwareScripts[scriptName] = scriptText;
    logToTerminal(`Script '${scriptName}' saved. You can run it via 'run myscript.t' command in Terminal.`, "system");
  });

  // --- PHONE SYSTEM ---

  const phoneContactsList = $("phone-contacts");
  const phoneChatDiv = $("phone-chat");
  const phoneInput = $("phone-input");

  // Initialize contacts with NPCs + player
  state.phoneContacts = Object.keys(state.players).filter(p => p !== playerName);

  function renderPhoneContacts() {
    phoneContactsList.innerHTML = "";
    state.phoneContacts.forEach(name => {
      const li = createEl("li", {text: name, attrs: {tabindex: "0"}});
      li.addEventListener("click", () => {
        openChatWith(name);
      });
      li.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          openChatWith(name);
          e.preventDefault();
        }
      });
      phoneContactsList.appendChild(li);
    });
  }

  let activeChat = null;

  function openChatWith(contactName) {
    activeChat = contactName;
    // highlight selected contact
    Array.from(phoneContactsList.children).forEach(li => {
      li.classList.toggle("active", li.textContent === contactName);
    });
    renderChatMessages(contactName);
  }
  function renderChatMessages(contactName) {
    const msgs = state.phoneChats[contactName] || [];
    phoneChatDiv.innerHTML = "";
    msgs.forEach(msg => {
      const div = createEl("div");
      div.textContent = `[${msg.time}] ${msg.sender}: ${msg.text}`;
      div.style.marginBottom = "6px";
      if (msg.sender === playerName) div.style.color = "#00ffcc";
      else div.style.color = "#aad4ff";
      phoneChatDiv.appendChild(div);
    });
    phoneChatDiv.scrollTop = phoneChatDiv.scrollHeight;
  }

  phoneInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && activeChat) {
      const text = phoneInput.value.trim();
      if (text) {
        sendMessageTo(activeChat, text);
        phoneInput.value = "";
      }
    }
  });

  function sendMessageTo(contactName, message) {
    if (!state.phoneChats[contactName]) state.phoneChats[contactName] = [];
    const nowStr = new Date().toLocaleTimeString();
    state.phoneChats[contactName].push({sender: playerName, text: message, time: nowStr});
    renderChatMessages(contactName);
    // NPC auto-reply simulation (delayed)
    setTimeout(() => {
      const reply = generateAutoReply(contactName, message);
      if (!state.phoneChats[contactName]) state.phoneChats[contactName] = [];
      const replyTime = new Date().toLocaleTimeString();
      state.phoneChats[contactName].push({sender: contactName, text: reply, time: replyTime});
      if (activeChat === contactName) renderChatMessages(contactName);
    }, 1500 + Math.random()*2000);
  }

  function generateAutoReply(name, message) {
    const replies = {
      Alice: ["Hi!", "I'm busy hacking, talk later.", "Got your message.", "Sounds good.", "Be careful out there."],
      Bob: ["Hey!", "On it.", "Roger that.", "Can't talk long.", "What's the target?"],
      Charlie: ["Hello.", "Check the new servers.", "I'll update the firewall soon.", "Got it.", "Stay safe."],
      Delta: ["Greetings.", "Running malware scan now.", "I'll ping you soon.", "Thanks.", "Keep your malware updated."],
    };
    const options = replies[name] || ["Ok.", "Got it.", "Hmm.", "Alright."];
    return randomChoice(options);
  }

  // --- BLACK MARKET STORE ---

  const blackMarketList = $("blackmarket-list");

  function loadBlackMarketItems() {
    state.blackMarketItems = [
      {id:"malware0", name:"Basic Malware", desc:"Simple malware that steals small amounts of data.", price:100, effect: () => {
        const player = state.players[playerName];
        player.malwareInstalled = true;
        player.malwareProtection = false;
        logToTerminal("Basic malware installed on your system.", "info");
      }},
      {id:"malware1", name:"Advanced Malware", desc:"Stealthy malware that avoids detection better.", price:500, effect: () => {
        const player = state.players[playerName];
        player.malwareInstalled = true;
        player.malwareProtection = true;
        logToTerminal("Advanced malware installed with stealth protection.", "info");
      }},
      {id:"firewall1", name:"Firewall Upgrade", desc:"Increase your firewall level to defend better.", price:750, effect: () => {
        const player = state.players[playerName];
        // just a demo, no effect yet
        logToTerminal("Firewall upgraded, better defense enabled.", "info");
      }},
      {id:"cpuup", name:"CPU Booster", desc:"Increase max CPU by 20 units.", price:900, effect: () => {
        state.cpuMax += 20;
        logToTerminal("CPU capacity increased by 20 units.", "info");
      }},
      {id:"screenshare", name:"Screen Sharing Tool", desc:"Allows sharing your screen logs with friends.", price:300, effect: () => {
        logToTerminal("Screen sharing enabled.", "info");
      }},
    ];
  }

  function renderBlackMarket() {
    blackMarketList.innerHTML = "";
    state.blackMarketItems.forEach(item => {
      const div = createEl("div", {cls: "blackmarket-item"});
      div.tabIndex = 0;
      div.setAttribute("role", "button");
      div.setAttribute("aria-label", `Buy ${item.name} for $${item.price}`);
      div.innerHTML = `<h3>${item.name}</h3><p>${item.desc}</p><p><b>Price:</b> $${item.price}</p>`;
      div.addEventListener("click", () => {
        purchaseItem(item.id);
      });
      div.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          purchaseItem(item.id);
          e.preventDefault();
        }
      });
      blackMarketList.appendChild(div);
    });
  }

  function purchaseItem(itemId) {
    const item = state.blackMarketItems.find(i => i.id === itemId);
    if (!item) return;
    const player = state.players[playerName];
    if (player.funds < item.price) {
      alert("Insufficient funds.");
      return;
    }
    player.funds -= item.price;
    player.blackMarketPurchased.push(itemId);
    item.effect();
    logToTerminal(`Purchased item: ${item.name} for $${item.price}`, "system");
  }

  // --- SETTINGS HANDLING ---

  const settingResolution = $("setting-resolution");
  const settingVolume = $("setting-volume");
  const settingTerminalColor = $("setting-terminal-color");

  function applySettings() {
    const color = settingTerminalColor.value;
    switch (color) {
      case "green":
        terminalOutput.style.color = "#0f0";
        terminalInput.style.color = "#0f0";
        terminalInput.style.background = "#001000cc";
        break;
      case "blue":
        terminalOutput.style.color = "#0af";
        terminalInput.style.color = "#0af";
        terminalInput.style.background = "#001022cc";
        break;
      case "cyan":
        terminalOutput.style.color = "#0ff";
        terminalInput.style.color = "#0ff";
        terminalInput.style.background = "#002033cc";
        break;
      case "purple":
        terminalOutput.style.color = "#a0a";
        terminalInput.style.color = "#a0a";
        terminalInput.style.background = "#220022cc";
        break;
      default:
        terminalOutput.style.color = "#0f0";
        terminalInput.style.color = "#0f0";
        terminalInput.style.background = "#001000cc";
    }
  }

  settingResolution.addEventListener("change", () => {
    state.settings.resolution = settingResolution.value;
    // For demo: we do not actually change screen size
    logToTerminal(`Resolution changed to ${state.settings.resolution}`, "system");
  });
  settingVolume.addEventListener("input", () => {
    state.settings.volume = settingVolume.value;
    logToTerminal(`Volume set to ${state.settings.volume}`, "system");
  });
  settingTerminalColor.addEventListener("change", () => {
    state.settings.terminalColor = settingTerminalColor.value;
    applySettings();
  });

  // --- INITIALIZATION ---

  function init() {
    renderServersList();
    selectServer(state.currentServer);
    renderPhoneContacts();
    loadBlackMarketItems();
    renderBlackMarket();
    applySettings();
    logToTerminal("Welcome to HackerSim v1.0! Type 'help' for commands.", "system");
  }

  init();

})();
</script>

</body>
</html>
